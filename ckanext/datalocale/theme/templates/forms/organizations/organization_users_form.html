<form id="publisher-edit" action="" method="post"
    py:attrs="{'class':'has-errors'} if errors else {}"
    xmlns:i18n="http://genshi.edgewall.org/i18n"
    xmlns:py="http://genshi.edgewall.org/"
    xmlns:xi="http://www.w3.org/2001/XInclude">

<div class="error-explanation" py:if="error_summary">
	<h2>Errors in form</h2>
	<p>The form contains invalid entries:</p>
	<ul>
	  <li py:for="key, error in error_summary.items()">${"%s: %s" % (key, error)}</li>
	</ul>
</div>

<input type="hidden" id="type" name="type" value="organization" />

<fieldset id="users">
  <h3>Users</h3>
  <table py:if="data.get('users')"><tbody>
    <py:for each="num, user in enumerate(data.get('users'))">
      <tr>
        <td>
          <input checked="checked" id="users__${num}__name" name="users__${num}__name" type="checkbox" value="${user['name']}" style="display:none"/>
          <label for="users__${num}__name">${user['name']}</label>
        </td>
        <td>
          <input type="radio" name="users__${num}__capacity" value="admin"  py:attrs="{'checked': 'checked' if user['capacity'] == 'admin' else None}"> Admin</input>
          <input type="radio" name="users__${num}__capacity" value="editor" py:attrs="{'checked': 'checked' if user['capacity'] in ['editor','member'] else None}"> Editor</input>
        </td>
        <td><button onclick="return delete_user(this);">Delete</button></td>
      </tr>
    </py:for>
  </tbody></table>

  <p py:if="not data.get('users')">There are no users currently in this organization.</p>

	  <h3>Add users</h3>
	  <dl>
	  	<dt>Type</dt>
	  	<dd><select id="user_group" name="user_group"><option value="admin">Administrateur</option><option value="editor">Editeur</option></select></dd>
	    <dt><label class="field_opt" for="users__${len(data.get('users', []))}__name">User</label></dt>
	    <dd><input class="autocomplete-dorganization-user" id="users__${len(data.get('users', []))}__name" name="users__${len(data.get('users', []))}__name" type="text" /></dd>
	  </dl>
</fieldset>


<div class="form-submit">
  <input id="save" class="pretty-button primary" name="save" type="submit" value="${_('Save')}" />
  <py:if test="c.group">
    <input id="cancel" class="pretty-button href-action" name="cancel" type="reset" value="${_('Cancel')}" action="${h.url_for(controller='group', action='edit', id=c.group.name)}#users" />
  </py:if>
</div>
<script language="javascript" src="/scripts/jquery-latest.min.js"></script>
<script type="text/javascript" src="/scripts/vendor/jqueryui/1.8.14/jquery-ui.min.js"></script>
<script type="text/javascript">
	function delete_user(btn) {
		var btn = $(btn)[0];
		var tr = $(btn).parents('tr');
		var chk = $(tr).find(":checkbox");
        chk.prop('checked', !chk.prop('checked'));
		if(chk.is(':checked') ) {
			$(tr).css({ opacity: 1 });
			$(btn).html('Supprimer');
		} else {
			$(tr).css({ opacity: 0.5 });
			$(btn).html('Annuler');
		}
		return false;
	}
	
   $('input.autocomplete-dorganization-user').autocomplete({
      minLength: 2,
      source: function(request, callback) {
        var url = '/api/2/util/user/autocomplete?q=' + request.term;
        $.getJSON(url, function(data) {
          $.each(data, function(idx, userobj) {
            var label = userobj.name;
            if (userobj.fullname) {
              label += ' [' + userobj.fullname + ']';
            }
            userobj.label = label;
            userobj.value = userobj.name;
          });
          callback(data);
        });
      },
      select: function(event, ui) {
        var input_box = $(this);
        input_box.val('');
        var parent_dd = input_box.parent('dd');
        var old_name = input_box.attr('name');
        var field_name_regex = /^(\S+)__(\d+)__(\S+)$/;
        var split = old_name.match(field_name_regex);
        var new_name = split[1] + '__' + (parseInt(split[2],10) + 1) + '__' + split[3];
        input_box.attr('name', new_name);
        input_box.attr('id', new_name);
        select_group = $("#user_group");
        parent_dd.before(
          '<input type="hidden" name="' + old_name + '" value="' + ui.item.value + '" />' +
          '<input type="hidden" name="' + old_name.replace('__name','__capacity') + '" value="'+select_group.val()+'" />' +
          '<dd>' + ui.item.label + '('+select_group.val()+')</dd>'
        );
        return false; // to cancel the event ;)
      }
    });
	
</script>

</form>

